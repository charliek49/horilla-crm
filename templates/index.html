{% load static i18n horilla_tags %}
<!DOCTYPE html>
<html class="{% if request.session.theme == 'dark' %}dark{% endif %}">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ TITLE }}</title>

    <!-- Cache theme variables -->
    {% with theme=request.active_company.companytheme_set.first.theme %}

    <!-- Theme Initialization (Blocking) -->
    <script>
        (function () {
            const theme = localStorage.getItem("theme") || "light";
            const html = document.documentElement;

            if (theme === "dark") {
                html.classList.add("dark");
                html.style.colorScheme = "dark";
            } else {
                html.classList.remove("dark");
                html.style.colorScheme = "light";
            }
        })();
    </script>

    <!-- Core Scripts -->
    <script src="{% static 'assets/js/tailwind/tailwind.js' %}"></script>
    <script>
        window.tailwind.config = {
            theme: {
                colors: {
                    white: '#FFFFFF',
                    primary: {
                        50:  '{{ theme.primary_50  | default:"#f6f6f6" }}',
                        100: '{{ theme.primary_100 | default:"#FFF5F1" }}',
                        200: '{{ theme.primary_200 | default:"#FEF6F5" }}',
                        300: '{{ theme.primary_300 | default:"#FCEDEB" }}',
                        400: '{{ theme.primary_400 | default:"#FBE5E1" }}',
                        500: '{{ theme.primary_500 | default:"#F7C8C1" }}',
                        600: '{{ theme.primary_600 | default:"#E54F38" }}',
                        700: '{{ theme.primary_700 | default:"#ce4732" }}',
                        800: '{{ theme.primary_800 | default:"#AC3B2A" }}',
                        900: '{{ theme.primary_900 | default:"#672419" }}',
                    },
                    dark: {
                        50:  '{{ theme.dark_50  | default:"#E6E6E6" }}',
                        100: '{{ theme.dark_100 | default:"#A8A8A8" }}',
                        200: '{{ theme.dark_200 | default:"#515151" }}',
                        300: '{{ theme.dark_300 | default:"#501C14" }}',
                        400: '{{ theme.dark_400 | default:"#64748B" }}',
                        500: '{{ theme.dark_500 | default:"#190906" }}',
                        600: '{{ theme.dark_600 | default:"#000000" }}',
                    },
                    secondary: {
                        50:  '{{ theme.secondary_50  | default:"#f8fafc" }}',
                        100: '{{ theme.secondary_100 | default:"#f1f5f9" }}',
                        200: '{{ theme.secondary_200 | default:"#e2e8f0" }}',
                        300: '{{ theme.secondary_300 | default:"#cbd5e1" }}',
                        400: '{{ theme.secondary_400 | default:"#FBE5E1" }}',
                        500: '{{ theme.secondary_500 | default:"#F7C8C1" }}',
                        600: '{{ theme.secondary_600 | default:"#E54F38" }}',
                        700: '{{ theme.secondary_700 | default:"#334155" }}',
                        800: '{{ theme.secondary_800 | default:"#1e293b" }}',
                        900: '{{ theme.secondary_900 | default:"#0f172a" }}',
                    },
                    success: { light: "#86efac", DEFAULT: "#22c55e", dark: "#15803d" },
                    warning: { light: "#fde68a", DEFAULT: "#f59e0b", dark: "#b45309" },
                    danger: { light: "#fca5a5", DEFAULT: "#ef4444", dark: "#b91c1c" },
                },
                extend: {
                    boxShadow: { card: "0px 0px 10px rgba(0, 0, 0, 0.05)" },
                    spacing: { 18: "4.5rem", 72: "18rem", 84: "21rem", 96: "24rem" },
                    borderRadius: { "4xl": "2rem", "5xl": "2.5rem" },
                    fontSize: { xxs: "0.625rem" },
                    height: { "screen-50": "50vh", "screen-75": "75vh" },
                },
            },
        };
    </script>
    <script>
        (function() {
            const defaultColor = '#AC3B2A';
            const currentColor = '{{ theme.primary_800|default:"#AC3B2A" }}';

            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16) / 255,
                    g: parseInt(result[2], 16) / 255,
                    b: parseInt(result[3], 16) / 255
                } : null;
            }

            function rgbToHsl(r, g, b) {
                const max = Math.max(r, g, b);
                const min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;

                if (max === min) {
                    h = s = 0;
                } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

                    switch (max) {
                        case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                        case g: h = ((b - r) / d + 2) / 6; break;
                        case b: h = ((r - g) / d + 4) / 6; break;
                    }
                }

                return { h: h * 360, s: s * 100, l: l * 100 };
            }

            if (currentColor.toLowerCase() === defaultColor.toLowerCase()) {
                document.documentElement.style.setProperty('--svg-filter', 'none');
                document.documentElement.style.setProperty('--svg-hue', '0deg');
                return;
            }

            const defaultRgb = hexToRgb(defaultColor);
            const currentRgb = hexToRgb(currentColor);

            if (!defaultRgb || !currentRgb) return;

            const defaultHsl = rgbToHsl(defaultRgb.r, defaultRgb.g, defaultRgb.b);
            const currentHsl = rgbToHsl(currentRgb.r, currentRgb.g, currentRgb.b);

            let hueDiff = currentHsl.h - defaultHsl.h;
            if (hueDiff > 180) hueDiff -= 360;
            if (hueDiff < -180) hueDiff += 360;

            const saturationRatio = currentHsl.s / defaultHsl.s || 1;
            const lightnessRatio = currentHsl.l / defaultHsl.l || 1;

            if (currentHsl.s < 10) {
                const brightness = lightnessRatio > 1 ? lightnessRatio : 1;
                document.documentElement.style.setProperty(
                    '--svg-filter',
                    `grayscale(1) brightness(${brightness.toFixed(2)})`
                );
                document.documentElement.style.setProperty('--svg-hue', '0deg');
            } else {
                const saturate = Math.max(0.5, Math.min(2, saturationRatio));
                const brightness = Math.max(0.5, Math.min(1.5, lightnessRatio));

                document.documentElement.style.setProperty(
                    '--svg-filter',
                    `hue-rotate(${hueDiff.toFixed(1)}deg) saturate(${saturate.toFixed(2)}) brightness(${brightness.toFixed(2)})`
                );
                document.documentElement.style.setProperty('--svg-hue', `${hueDiff.toFixed(1)}deg`);
            }
        })();
    </script>

    <script src="{% static 'assets/js/htmx/htmx.min.js' %}"></script>
    <script src="{% static 'assets/js/cloudflare/htmx.min.js' %}"></script>
    <script src="{% static 'assets/js/cloudflare/jquery.min.js' %}"></script>
    <script src="{% static 'assets/js/jquery/jquery-3.7.1.js' %}"></script>
    <script src="{% static 'assets/js/hyperscript/hyperscript.min.js' %}"></script>

    <!-- UI Libraries (Defer Non-Critical) -->
    <script src="{% static 'assets/js/flowbite/flowbite.min.js' %}"></script>
    <script src="{% static 'assets/js/sweetalert2.js' %}"></script>
    <script src="{% static 'assets/js/select2.min.js' %}"></script>
    <script src="{% static 'assets/js/sortablejs/Sortable.min.js' %}"></script>
    <script src="{% static 'assets/js/summernote/summernote-lite.min.js' %}"></script>

    <!-- Chart Libraries -->
    <script src="{% static 'assets/js/cloudflare/chart.min.js' %}"></script>
    <script src="{% static 'assets/js/echart/echarts.min.js' %}"></script>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="{% static 'assets/css/flowbite/flowbite.min.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/fontawesome/css/all.min.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/dark.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/calendar.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/select2.min.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/sweetalert_toast/toast.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/animate.min.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/summernote/summernote-lite.min.css' %}" />

    <!-- Dynamic Styles -->
    <style>
        input[type="checkbox"]{color:{{ theme.primary_600|default:"#E54F38" }}}
        .progress li.active .sec::before{background-color:{{ theme.primary_600|default:"#E54F38" }}}
        .select2-container--default .select2-results__option--highlighted.select2-results__option--selectable{background-color:{{ theme.primary_100|default:"#e54f3817" }}!important;color:{{ theme.primary_600|default:"#E54F38" }}!important}
        .select2-container--default .select2-selection--multiple .select2-selection__choice{background-color:{{ theme.primary_600|default:"#E54F38" }}}
        .radio-group input[type="radio"]:checked+.custom-radio::after{background-color:{{ theme.primary_600|default:"#E54F38" }}}
        .dropdown-content a:hover{color:{{ theme.primary_600|default:"#E54F38" }}}
        .dropdown-content{border-color:{{ theme.primary_400|default:"#FBE5E1" }}}
        .core-module{background:linear-gradient(135deg,{{ theme.primary_600|default:"#E54F38" }} 0%,{{ theme.primary_800|default:"#C5311B" }} 100%)}
    </style>

    {% endwith %}

    {% block extra_css %}{% endblock extra_css %}

    <!-- Google Fonts (Preconnect) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="{% static 'assets/css/googlefonts/css2.css' %}" />

</head>

<body class="bg-secondary-50 font-[Inter,_sans-serif]">
    <!-- Apply Dark Mode to Body -->
    <script>
        !function(){const t=localStorage.getItem("theme");"dark"===t&&document.body.classList.add("dark")}();
    </script>

    <!-- Main Content Wrapper -->
    <div class="ml-[4.8rem] h-screen">
        <!-- Header -->
        <div id="header">
            {% include 'components/header.html' %}
        </div>

        <!-- Page Content -->
        {% block content %}{% endblock content %}

        <!-- Modals -->
        {% include "components/horilla_modals.html" %}
    </div>

    <!-- Sidebar -->
    <div id="sidebar">
        {% include 'components/sidebar.html' %}
    </div>

    <!-- Messages Reload Button -->
    <button id="reloadMessagesButton" hx-get="{% url 'horilla_core:reload_messages' %}" hx-swap="afterend"
        hx-target="#reloadMessages" hidden>
    </button>
    <div id="reloadMessages">
        {% include "messages.html" %}
    </div>

    <!-- HTMX CSRF Token Configuration -->
    <script>
        document.body.addEventListener("htmx:configRequest", (event) => {
            event.detail.headers["X-CSRFToken"] = "{{ csrf_token }}";
        });
    </script>

    <!-- Global Scripts (Defer) -->
    <script src="{% url 'javascript-catalog' %}"></script>
    <script src="{% static 'assets/js/global.js' %}"></script>
    <script src="{% static 'assets/js/horilla_charts.js' %}"></script>
    <script src="{% static 'assets/js/calendar.js' %}"></script>
    <script src="{% static 'assets/js/full_calendar.js' %}"></script>

    <!-- Dynamically Registered Scripts -->
    {% load_registered_js as register_js %}
    {% for js_file in register_js %}
    <script src="{% static js_file %}"></script>
    {% endfor %}

    {% block extra_js %}{% endblock extra_js %}
</body>

</html>
