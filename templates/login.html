{% load static i18n %}
<!DOCTYPE html>
<html class="{% if request.session.theme == 'dark' %}dark{% endif %}">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ TITLE }} - Login</title>

    <!-- Theme Initialization (Blocking) -->
    <script>
        (function () {
            const theme = localStorage.getItem("theme") || "light";
            const html = document.documentElement;

            if (theme === "dark") {
                html.classList.add("dark");
                html.style.colorScheme = "dark";
            } else {
                html.classList.remove("dark");
                html.style.colorScheme = "light";
            }
        })();
    </script>

    <!-- Core Scripts -->
    <script src="{% static 'assets/js/tailwind/tailwind.js' %}"></script>
    <script>
        (function() {
            // Check localStorage for last active company theme
            const lastActiveTheme = localStorage.getItem('lastActiveTheme');
            let themeData = null;

            if (lastActiveTheme) {
                try {
                    themeData = JSON.parse(lastActiveTheme);
                } catch (e) {
                    console.error('Error parsing theme from localStorage:', e);
                }
            }

            // If no theme in localStorage, use default theme from server
            {% if theme %}
            if (!themeData) {
                themeData = {
                    id: {{ theme.id }},
                    primary_50: '{{ theme.primary_50|default:"#f6f6f6" }}',
                    primary_100: '{{ theme.primary_100|default:"#FFF5F1" }}',
                    primary_200: '{{ theme.primary_200|default:"#FEF6F5" }}',
                    primary_300: '{{ theme.primary_300|default:"#FCEDEB" }}',
                    primary_400: '{{ theme.primary_400|default:"#FBE5E1" }}',
                    primary_500: '{{ theme.primary_500|default:"#F7C8C1" }}',
                    primary_600: '{{ theme.primary_600|default:"#E54F38" }}',
                    primary_700: '{{ theme.primary_700|default:"#ce4732" }}',
                    primary_800: '{{ theme.primary_800|default:"#AC3B2A" }}',
                    primary_900: '{{ theme.primary_900|default:"#672419" }}',
                    dark_25: '{{ theme.dark_25|default:"#F0F0F0" }}',
                    dark_50: '{{ theme.dark_50|default:"#E6E6E6" }}',
                    dark_100: '{{ theme.dark_100|default:"#A8A8A8" }}',
                    dark_200: '{{ theme.dark_200|default:"#515151" }}',
                    dark_300: '{{ theme.dark_300|default:"#501C14" }}',
                    dark_400: '{{ theme.dark_400|default:"#64748B" }}',
                    dark_500: '{{ theme.dark_500|default:"#190906" }}',
                    dark_600: '{{ theme.dark_600|default:"#000000" }}',
                    secondary_50: '{{ theme.secondary_50|default:"#f8fafc" }}',
                    secondary_100: '{{ theme.secondary_100|default:"#f1f5f9" }}',
                    secondary_200: '{{ theme.secondary_200|default:"#e2e8f0" }}',
                    secondary_300: '{{ theme.secondary_300|default:"#cbd5e1" }}',
                    secondary_400: '{{ theme.secondary_400|default:"#FBE5E1" }}',
                    secondary_500: '{{ theme.secondary_500|default:"#F7C8C1" }}',
                    secondary_600: '{{ theme.secondary_600|default:"#E54F38" }}',
                    secondary_700: '{{ theme.secondary_700|default:"#334155" }}',
                    secondary_800: '{{ theme.secondary_800|default:"#1e293b" }}',
                    secondary_900: '{{ theme.secondary_900|default:"#0f172a" }}',
                };
            }
            {% endif %}

            // Apply theme configuration
            if (themeData) {
                window.tailwind.config = {
                    theme: {
                        colors: {
                            white: '#FFFFFF',
                            primary: {
                                50:  themeData.primary_50 || '#f6f6f6',
                                100: themeData.primary_100 || '#FFF5F1',
                                200: themeData.primary_200 || '#FEF6F5',
                                300: themeData.primary_300 || '#FCEDEB',
                                400: themeData.primary_400 || '#FBE5E1',
                                500: themeData.primary_500 || '#F7C8C1',
                                600: themeData.primary_600 || '#E54F38',
                                700: themeData.primary_700 || '#ce4732',
                                800: themeData.primary_800 || '#AC3B2A',
                                900: themeData.primary_900 || '#672419',
                            },
                            dark: {
                                25:  themeData.dark_25 || '#F0F0F0',
                                50:  themeData.dark_50 || '#E6E6E6',
                                100: themeData.dark_100 || '#A8A8A8',
                                200: themeData.dark_200 || '#515151',
                                300: themeData.dark_300 || '#501C14',
                                400: themeData.dark_400 || '#64748B',
                                500: themeData.dark_500 || '#190906',
                                600: themeData.dark_600 || '#000000',
                            },
                            secondary: {
                                50:  themeData.secondary_50 || '#f8fafc',
                                100: themeData.secondary_100 || '#f1f5f9',
                                200: themeData.secondary_200 || '#e2e8f0',
                                300: themeData.secondary_300 || '#cbd5e1',
                                400: themeData.secondary_400 || '#FBE5E1',
                                500: themeData.secondary_500 || '#F7C8C1',
                                600: themeData.secondary_600 || '#E54F38',
                                700: themeData.secondary_700 || '#334155',
                                800: themeData.secondary_800 || '#1e293b',
                                900: themeData.secondary_900 || '#0f172a',
                            },
                            success: { light: "#86efac", DEFAULT: "#22c55e", dark: "#15803d" },
                            warning: { light: "#fde68a", DEFAULT: "#f59e0b", dark: "#b45309" },
                            danger: { light: "#fca5a5", DEFAULT: "#ef4444", dark: "#b91c1c" },
                        },
                        extend: {
                            boxShadow: { card: "0px 0px 10px rgba(0, 0, 0, 0.05)" },
                            spacing: { 18: "4.5rem", 72: "18rem", 84: "21rem", 96: "24rem" },
                            borderRadius: { "4xl": "2rem", "5xl": "2.5rem" },
                            fontSize: { xxs: "0.625rem" },
                            height: { "screen-50": "50vh", "screen-75": "75vh" },
                        },
                    },
                };

                // SVG filter calculation
                const defaultColor = '#AC3B2A';
                const currentColor = themeData.primary_800 || '#AC3B2A';

                function hexToRgb(hex) {
                    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                    return result ? {
                        r: parseInt(result[1], 16) / 255,
                        g: parseInt(result[2], 16) / 255,
                        b: parseInt(result[3], 16) / 255
                    } : null;
                }

                function rgbToHsl(r, g, b) {
                    const max = Math.max(r, g, b);
                    const min = Math.min(r, g, b);
                    let h, s, l = (max + min) / 2;

                    if (max === min) {
                        h = s = 0;
                    } else {
                        const d = max - min;
                        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

                        switch (max) {
                            case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                            case g: h = ((b - r) / d + 2) / 6; break;
                            case b: h = ((r - g) / d + 4) / 6; break;
                        }
                    }

                    return { h: h * 360, s: s * 100, l: l * 100 };
                }

                if (currentColor.toLowerCase() === defaultColor.toLowerCase()) {
                    document.documentElement.style.setProperty('--svg-filter', 'none');
                    document.documentElement.style.setProperty('--svg-hue', '0deg');
                } else {
                    const defaultRgb = hexToRgb(defaultColor);
                    const currentRgb = hexToRgb(currentColor);

                    if (defaultRgb && currentRgb) {
                        const defaultHsl = rgbToHsl(defaultRgb.r, defaultRgb.g, defaultRgb.b);
                        const currentHsl = rgbToHsl(currentRgb.r, currentRgb.g, currentRgb.b);

                        const hueDiff = currentHsl.h - defaultHsl.h;
                        document.documentElement.style.setProperty('--svg-hue', `${hueDiff}deg`);
                        document.documentElement.style.setProperty('--svg-filter', `hue-rotate(${hueDiff}deg)`);
                    }
                }
            } else {
                // Fallback to default tailwind config if no theme available
                {% if theme %}
                // This shouldn't happen, but just in case
                {% else %}
                // Load default config
                {% endif %}
            }
        })();
    </script>
    {% if not theme %}
    <script src="{% static 'assets/js/tailwind.config.js' %}"></script>
    {% endif %}
    <script src="{% static 'assets/js/htmx/htmx.min.js' %}"></script>
    <script src="{% static 'assets/js/cloudflare/jquery.min.js' %}"></script>
    <script src="{% static 'assets/js/cloudflare/chart.min.js' %}"></script>

    <!-- UI Library Scripts -->
    <script src="{% static 'assets/js/flowbite/flowbite.min.js' %}"></script>
    <script src="{% static 'assets/js/sweetalert2.js' %}"></script>
    <script src="{% static 'assets/js/select2.min.js' %}"></script>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="{% static 'assets/css/flowbite/flowbite.min.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/fontawesome/css/all.min.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/dark.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/calendar.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/select2.min.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/css/sweetalert_toast/toast.css' %}" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="{% static 'assets/css/googlefonts/css2.css' %}" />
</head>

<body class="bg-[#f8f8f9] font-[Inter,_sans-serif]">
    <!-- Apply Dark Mode to Body -->
    <script>
        (function () {
            const theme = localStorage.getItem("theme");
            if (theme === "dark") {
                document.body.classList.add("dark");
            }
        })();
    </script>

    <!-- Main Content Wrapper -->
    <div class="h-screen w-full flex items-center justify-center">
        <!-- Messages Container -->
        <div id="messages-container" style="display:none;">
            {% for message in messages %}
                <div class="message" data-level="{{ message.tags }}" data-message="{{ message }}"></div>
            {% endfor %}
        </div>

        {% block login %}
        <!-- LOGIN FORM -->
        <div id="sec1" class="bg-white p-[50px] rounded-md shadow w-[450px]">
            <img src="{% static LOGO_PATH %}" alt="{% trans 'Logo' %}" class="m-auto mb-4 w-24 h-24" />
            <h1 class="text-3xl font-bold mb-2 text-center">{{ LOGIN_WELCOME_LINE }}</h1>
            <p class="mb-5 text-center text-sm text-color-600">
                {{ LOGIN_TAG_LINE }}
            </p>

            <form method="post" action="{% url 'horilla_core:login' %}">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ next }}" />

                <div class="mb-3">
                    <label for="username" class="text-sm text-color-600">{% trans "Username" %}</label>
                    <input
                        id="username"
                        type="text"
                        name="username"
                        autocomplete="off"
                        placeholder="Enter Username"
                        required
                        class="text-color-600 w-full border border-dark-50 rounded-md p-3 mt-1 placeholder:text-dark-100 text-sm focus:border-primary-600 focus-visible:outline-0"
                    />
                </div>

                <label for="passwordInput" class="text-sm text-color-600">{% trans "Password" %}</label>
                <div class="relative {% if not show_forgot_password %}mb-4{% endif %}">
                    <input
                        id="passwordInput"
                        type="password"
                        name="password"
                        autocomplete="off"
                        placeholder="Enter Password"
                        required
                        class="text-color-600 p-3 pr-[40px] w-full border border-dark-50 rounded-md mt-1 placeholder:text-dark-100 text-sm focus:border-primary-600 focus-visible:outline-0"
                    />
                    <button type="button" onclick="togglePassword()" class="absolute right-3 top-0 bottom-0 m-auto cursor-pointer">
                        <img id="eyeIcon" src="{% static 'assets/icons/eye.svg' %}" alt="{% trans 'Toggle visibility' %}" />
                        <img id="eyeHideIcon" src="{% static 'assets/icons/eye-hide.svg' %}" width="21" alt="{% trans 'Toggle visibility' %}" class="hidden" />
                    </button>
                </div>

                {% if show_forgot_password %}
                <div class="flex justify-end">
                    <button
                        type="button"
                        hx-get="{% url 'horilla_core:forgot_password' %}"
                        hx-target="#sec1"
                        hx-select="#sec2"
                        hx-push-url="true"
                        hx-swap="outerHTML"
                        class="text-sm font-medium text-red-500 mb-3 mt-2 cursor-pointer"
                    >
                        {% trans "Forgot Password?" %}
                    </button>
                </div>
                {% endif %}

                <button
                    type="submit"
                    class="p-3 bg-primary-600 hover:bg-primary-800 w-full flex gap-3 justify-center rounded-md text-white transition duration-300"
                >
                    <img src="{% static 'assets/icons/sign.svg' %}" alt="{% trans 'Arrow' %}" />
                    {% trans "Sign In" %}
                </button>
            </form>

            {% if initialize_database %}
            <div class="grid grid-cols-2 gap-2 mt-5">
                <button
                    class="cursor-pointer btn-with-icon flex gap-3 text-sm px-[15px] py-[13px] rounded-md text-[#34c558] bg-[#e6fff5] hover:bg-[#34c558] hover:text-[white] transition duration-300 whitespace-nowrap"
                    hx-get="{% url 'horilla_core:load_data' %}"
                    hx-target="#sec1"
                    hx-swap="outerHTML"
                    hx-push-url="true"
                    hx-select="#load-sec"
                >
                    {% trans "Load Demo Data" %}
                    <img src="{% static 'assets/icons/ar1.svg' %}" alt="{% trans 'Arrow' %}" />
                </button>
                <button
                    class="btn-with-icon flex gap-3 text-sm px-[15px] py-[13px] rounded-md text-[#E54F38] bg-[#ffefed] hover:bg-[#e54f38] hover:text-[white] transition duration-300 cursor-pointer whitespace-nowrap"
                    hx-get="{% url 'horilla_core:initialize_database' %}"
                    hx-target="#sec1"
                    hx-swap="outerHTML"
                    hx-push-url="true"
                    hx-select="#initialize-sec"
                >
                    {% trans "Initialize Database" %}
                    <img src="{% static 'assets/icons/ar2.svg' %}" alt="{% trans 'Arrow' %}" />
                </button>
            </div>
            {% endif %}
        </div>
        {% endblock login %}
    </div>

    <!-- HTMX CSRF Token Configuration -->
    <script>
        document.body.addEventListener("htmx:configRequest", (event) => {
            event.detail.headers["X-CSRFToken"] = "{{ csrf_token }}";
        });
    </script>

    <!-- Password Toggle Function -->
    <script>
        function togglePassword() {
            const passwordInput = document.getElementById('passwordInput');
            const eyeIcon = document.getElementById('eyeIcon');
            const eyeHideIcon = document.getElementById('eyeHideIcon');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.add('hidden');
                eyeHideIcon.classList.remove('hidden');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('hidden');
                eyeHideIcon.classList.add('hidden');
            }
        }

        // Show div function (for login page sections)
        function showDiv(idToShow) {
            const divs = document.querySelectorAll('div[id^="sec"]');
            divs.forEach((div) => {
                div.style.display = div.id === idToShow ? "block" : "none";
            });
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            showDiv("sec1");
        });
    </script>

    <!-- Global Scripts -->
    <script src="{% url 'javascript-catalog' %}"></script>
    <script src="{% static 'assets/js/global.js' %}"></script>
</body>

</html>
